import backend.config as config
import backend.utils as utils
from datetime import date
from backend.pipelines.pipeline import PricePipeline, CorporateActionPipeline, MasterPipeline
from backend.pipelines.ingestors import YFinancePriceIngestor,CSVPriceIngestor, YFinanceCorporateActionsIngestor

# Configuration
yfinance_batch_size = 100
start_date = date.fromisoformat("1970-01-01")
end_date = date.fromisoformat("2025-06-30")
base_save_path = config.EXTERNAL_DATA_BASE_PATH

# Fetch ticker data
yfinance_test_tickers = ['AAPL','GOOG','MSFT']
yfinance_tickers_ukstock = utils.get_yfinance_tickers("uk stock")
yfinance_tickers_cryptocurrency = utils.get_yfinance_tickers("cryptocurrency")
yfinance_tickers_etf = utils.get_yfinance_tickers("etf")
yfinance_tickers_usstock = utils.get_yfinance_tickers("us stock")
yfinance_tickers_mutualfund = utils.get_yfinance_tickers("mutual fund")
csv_ticker_source_map = utils.get_csv_ticker_source_map()

# Instantiate list of ingestors
price_ingestors = []
corporate_action_ingestors = []

# Add price ingestors
price_ingestors.append(YFinancePriceIngestor(yfinance_test_tickers,yfinance_batch_size,start_date,end_date))

# Add action ingestors
corporate_action_ingestors.append(YFinanceCorporateActionsIngestor(yfinance_test_tickers,yfinance_batch_size,start_date,end_date))

# Instantiate minor pipelines
price_pipeline = PricePipeline(price_ingestors)
action_pipeline = CorporateActionPipeline(corporate_action_ingestors)

# Instantiate major pipeline and run
master_pipeline = MasterPipeline(price_pipeline,action_pipeline,base_save_path)
master_pipeline.run()